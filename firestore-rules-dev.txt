rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    match /waitlist/{waitlistId} {
      allow create: if true;
      allow read, update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /dogs/{dogId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /litters/{litterId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /buyers/{buyerId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /healthRecords/{recordId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /breeders/{breederId} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == breederId;
    }

    match /breeder_profiles/{profileId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /inquiries/{inquiryId} {
      allow create: if true;
      allow read, update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /customers/{customerId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /heat_cycles/{cycleId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /breeding_records/{recordId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Litter care and workflow tasks - scoped to breeder
    match /litterTasks/{taskId} {
      // Breeder can read their own litter tasks
      allow read, update, delete: if isAuthenticated() &&
        isOwner(resource.data.breederId);

      // Creating tasks (e.g., from templates) must set breederId to the caller
      allow create: if isAuthenticated() &&
        isOwner(request.resource.data.breederId);
    }
  }
}
